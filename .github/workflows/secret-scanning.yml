name: üîí Secret Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files
        run: |
          if find . -name ".env" -o -name ".env.*" | grep -v node_modules | grep -v ".git"; then
            echo "‚ùå FEIL: .env filer funnet i repository!"
            echo "Fjern .env filer f√∏r du pusher."
            exit 1
          fi
          echo "‚úÖ Ingen .env filer funnet"

      - name: Check for hardcoded API keys
        run: |
          # Sjekk for Firebase API keys (starter med AIza)
          if grep -r "AIza[0-9A-Za-z_-]\{35\}" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules .; then
            echo "‚ùå FEIL: Hardkodede API-n√∏kler funnet!"
            echo "Bruk process.env.EXPO_PUBLIC_* i stedet."
            exit 1
          fi
          echo "‚úÖ Ingen hardkodede API-n√∏kler funnet"

      - name: Check for common secrets
        run: |
          # Sjekk for vanlige secret-m√∏nstre
          SECRETS_FOUND=0
          
          # Firebase Service Account JSON
          if grep -r "type.*service_account" --include="*.json" --exclude-dir=node_modules .; then
            echo "‚ùå FEIL: Service Account JSON funnet!"
            SECRETS_FOUND=1
          fi
          
          # Private keys
          if find . -name "*.pem" -o -name "*.key" -o -name "*.p12" | grep -v node_modules | grep -v ".git"; then
            echo "‚ùå FEIL: Private key-filer funnet!"
            SECRETS_FOUND=1
          fi
          
          # Passwords i kode
          if grep -ri "password.*=.*['\"][^'\"]\{8,\}" --include="*.js" --include="*.jsx" --exclude-dir=node_modules .; then
            echo "‚ö†Ô∏è  ADVARSEL: Mulige hardkodede passord funnet!"
          fi
          
          if [ $SECRETS_FOUND -eq 1 ]; then
            exit 1
          fi
          
          echo "‚úÖ Ingen secrets funnet"

      - name: Verify .gitignore
        run: |
          if ! grep -q "^\.env$" .gitignore; then
            echo "‚ùå FEIL: .env mangler i .gitignore!"
            exit 1
          fi
          echo "‚úÖ .env er i .gitignore"
